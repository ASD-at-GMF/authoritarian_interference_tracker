<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>New Incident • Admin</title>
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;600;700&family=Space+Mono:wght@400;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    .admin {
      max-width: 960px;
      margin: 2rem auto;
    }

    .hdr {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .hdr h1 {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: .12em;
      font-size: clamp(18px, 2.6vw, 24px);
    }

    .card form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media(min-width: 900px) {
      .card form {
        grid-template-columns: 1fr 1fr;
      }
    }

    .frow {
      display: flex;
      flex-direction: column;
      gap: .35rem;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea {
      padding: .6rem .7rem;
      border: 1px solid #ddd;
      border-radius: .5rem;
      width: 100%;
      background: #fff;
    }

    textarea {
      min-height: 120px;
    }

    .mono {
      font-family: 'Space Mono', monospace;
      font-size: 12px;
      opacity: .85;
    }

    .section {
      grid-column: 1 / -1;
      border-top: 1px dashed rgba(0, 0, 0, .15);
      padding-top: .75rem;
      margin-top: .25rem;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .chips {
      display: flex;
      gap: .35rem;
      flex-wrap: wrap;
    }

    .chipbtn {
      border: 1px solid #ddd;
      border-radius: 999px;
      padding: .25rem .55rem;
      cursor: pointer;
      font-size: 12px;
    }

    .chipbtn:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .actions {
      grid-column: 1 / -1;
      display: flex;
      gap: .6rem;
      align-items: center;
    }

    .small {
      font-size: 12px;
      opacity: .8;
    }
  </style>
</head>

<body class="container admin">
  <div class="hdr">
    <h1>{{ 'Edit Incident #' ~ incident.id if incident else 'New Incident' }}</h1>
    <div class="mono">
      <a href="/">← Back</a> · <a href="/admin/incidents">All Incidents</a> · <a href="/admin/logout">Logout</a>
    </div>
  </div>

  <section class="card">
    <div class="card-title">Compose <span class="sub">Create incident, relate countries, actors, and types</span></div>
    <div style="padding:1rem;">
      <form method="post"
        action="{{ url_for('admin_edit_incident', incident_id=incident.id) if incident else url_for('admin_new_incident') }}">
        <div class="frow">
          <label>Post ID (unique)</label>
          <input type="number" name="post_id" required value="{{ incident.post_id if incident else '' }}" />
        </div>
        <div class="frow">
          <label>Title</label>
          <input type="text" name="title" required value="{{ incident.title if incident else '' }}" />
        </div>
        <div class="frow">
          <label>Link</label>
          <input type="text" name="link" placeholder="https://…" value="{{ incident.link if incident else '' }}" />
        </div>
        <div class="frow">
          <label>Start Date</label>
          <input type="date" name="start_date"
            value="{{ incident.start_date if incident and incident.start_date else '' }}" />
        </div>
        <div class="frow">
          <label>End Date</label>
          <input type="date" name="end_date"
            value="{{ incident.end_date if incident and incident.end_date else '' }}" />
        </div>

        <div class="frow" style="grid-column:1 / -1;">
          <label>Excerpt</label>
          <textarea name="excerpt_clean">{{ incident.excerpt_clean if incident else '' }}</textarea>
        </div>
        <div class="frow" style="grid-column:1 / -1;">
          <label>Content</label>
          <textarea name="content_clean">{{ incident.content_clean if incident else '' }}</textarea>
        </div>
        <div class="frow" style="grid-column:1 / -1;">
          <label class="mono">Freeform Date Text (optional)</label>
          <input type="text" name="date_text" value="{{ incident.date_text if incident else '' }}" />
        </div>

        <div class="section">
          <div class="grid2">
            <div class="frow">
              <label>Countries (comma / semicolon separated)</label>
              <input type="text" name="countries_csv" list="countries-list" placeholder="e.g., Canada; United States"
                value="{{ sel_countries if incident else '' }}" />
              <datalist id="countries-list">
                {% for c in countries %}<option value="{{ c }}">{% endfor %}
              </datalist>
              <div class="small mono">
                Auto-geocoding uses DB lat/lon; optional geopy/Nominatim fallback:
                {{ 'on' if allow_external_geocoding else 'off' }}
              </div>
            </div>
            <div></div>
          </div>
        </div>

        <div class="section">
          <div class="grid2">
            <div class="frow">
              <label>Threat Actors (multi-select)</label>
              <select name="actors_sel" multiple size="8" style="...">
                {% for a in actors %}
                <option value="{{ a }}" {% if incident and a in sel_actors %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
              </select>

              <label class="small">Add new threat actors (comma/semicolon):</label>
              <input type="text" name="new_actors" placeholder="e.g., Sandworm; APT10" />
              <div class="small mono">Tip: Cmd/Ctrl-click to select multiple.</div>
            </div>

            <div class="frow">
              <label>Incident Types (multi-select)</label>
              <select name="tools_sel" multiple size="8" style="...">
                {% for t in tools %}
                <option value="{{ t }}" {% if incident and t in sel_tools %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
              </select>
              <label class="small">Add new incident types (comma/semicolon):</label>
              <input type="text" name="new_tools" placeholder="e.g., Cyber; Coercion; Propaganda" />
              <div class="small mono">Tip: Cmd/Ctrl-click to select multiple.</div>
            </div>
          </div>
        </div>
        <div class="section">
          <div class="frow">
            <label>Source URLs (one per line or comma/semicolon separated)</label>
            <textarea name="sources_urls" placeholder="https://example.com/article-1
https://another.org/report">{{ sel_sources if incident else '' }}</textarea>
          </div>
        </div>


        <div class="section actions">
          <label><input type="checkbox" name="display" {% if not incident or incident.display %}checked{% endif %} />
            Publish / display</label>
          <button type="submit">{{ 'Save Changes' if incident else 'Save Incident' }}</button>
          {% if incident %}
          <form method="post" action="{{ url_for('admin_delete_incident', incident_id=incident.id) }}"
            onsubmit="return confirm('Delete incident #{{ incident.id }}?');">
            <button type="submit">Delete</button>
          </form>
          {% endif %}
          <span class="small mono">Post ID must be unique.</span>
        </div>
      </form>
    </div>
  </section>
</body>

</html>